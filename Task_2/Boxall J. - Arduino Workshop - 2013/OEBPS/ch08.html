<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:pls="http://www.w3.org/2005/01/pronunciation-lexicon" xmlns:ssml="http://www.w3.org/2001/10/synthesis" xmlns:svg="http://www.w3.org/2000/svg"><head><title>Chapter 8. Expanding Your Arduino</title><link rel="stylesheet" type="text/css" href="core.css"/><meta name="generator" content="DocBook XSL Stylesheets V1.76.1"/><link rel="up" href="index.html" title="Arduino Workshop: A hands-on introduction with 65 projects"/><link rel="prev" href="ch07.html" title="Chapter 7. Liquid Crystal Displays"/><link rel="next" href="ch09.html" title="Chapter 9. Numeric Keypads"/></head><body><section class="chapter" title="Chapter 8. Expanding Your Arduino" epub:type="chapter" id="expanding_your_arduino"><div class="titlepage"><div><div><h2 class="title">Chapter 8. Expanding Your Arduino</h2></div></div></div><p>In this chapter you will</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Learn about the broad variety of Arduino shields</p></li><li class="listitem"><p>Make your own Arduino shield using a ProtoShield</p></li><li class="listitem"><p>Understand how Arduino libraries can expand the available functions</p></li><li class="listitem"><p>Use a microSD card shield to record data that can be analyzed in a spreadsheet</p></li><li class="listitem"><p>Build a temperature-logging device</p></li><li class="listitem"><p>Learn how to make a stopwatch using <code class="literal">micros()</code> and <code class="literal">millis()</code></p></li><li class="listitem"><p>Understand Arduino interrupts and their uses</p></li></ul></div><p>We’ll continue to discover ways to expand our Arduino (using various shields), and you’ll follow an example to learn how to make your own shield. Over time, as you experiment with electronics and Arduino, you can make your circuits more permanent by building them onto a <span class="emphasis"><em>ProtoShield</em></span>, a blank printed circuit board that you can use to mount custom circuitry.</p><p>One of the more useful shields is the <span class="emphasis"><em>microSD</em></span> card shield. We’ll use it in this chapter to create a temperature-logging device to record temperatures over time; the shield will be used to record data from the Arduino to be transferred elsewhere for analysis.</p><p>You’ll learn about the functions <code class="literal">micros()</code> and <code class="literal">millis()</code>, which are very useful for keeping time, as you’ll see in the stopwatch project. Finally, we’ll examine interrupts.</p><div class="sect1" title="Shields"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="shields">Shields</h2></div></div></div><p>You can add functionality to your Arduino board by attaching <span class="emphasis"><em>shields</em></span>. A shield is a circuit board that connects via pins to the sockets on the sides of an Arduino. Hundreds of shields are available on the market. One popular project, for example, combines a GPS shield with a microSD memory card shield to create a device that logs and stores position over time, such as a car’s path of travel or the location of a new hiking trail. Other projects include Ethernet network adapters that let the Arduino access the Internet (<a class="xref" href="ch08.html#ethernet_shield_on_arduino_uno" title="Figure 8-1. Ethernet shield on Arduino Uno">Figure 8-1</a>).</p><div class="figure"><a id="ethernet_shield_on_arduino_uno"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00144"/><img src="httpatomoreillycomsourcenostarchimages1630050.png.jpg" alt="Ethernet shield on Arduino Uno"/></div></div><div class="figure-title">Figure 8-1. Ethernet shield on Arduino Uno</div></div><p>GPS satellite receivers let you track the location of the Arduino (<a class="xref" href="ch08.html#gps_receiver_shield_left_parenthesiswith" title="Figure 8-2. GPS receiver shield (with separate GPS module) on Arduino Uno">Figure 8-2</a>). MicroSD memory card interfaces let the Arduino store data on a memory card (<a class="xref" href="ch08.html#microsd_card_shield_kit" title="Figure 8-3. MicroSD card shield kit">Figure 8-3</a>).</p><p>Arduino shields are designed to be stacked, and they usually work in combination with other shields. For example, <a class="xref" href="ch08.html#three_stacked_shields_with_an_arduino_un" title="Figure 8-4. Three stacked shields with an Arduino Uno">Figure 8-4</a> shows a stack that includes an Arduino Uno, a microSD memory card shield to which data can be recorded, an Ethernet shield for connecting to the Internet, and an LCD shield to display information.</p><div class="figure"><a id="gps_receiver_shield_left_parenthesiswith"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00145"/><img src="httpatomoreillycomsourcenostarchimages1630052.png.jpg" alt="GPS receiver shield (with separate GPS module) on Arduino Uno"/></div></div><div class="figure-title">Figure 8-2. GPS receiver shield (with separate GPS module) on Arduino Uno</div></div><div class="figure"><a id="microsd_card_shield_kit"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00146"/><img src="httpatomoreillycomsourcenostarchimages1630054.png.jpg" alt="MicroSD card shield kit"/></div></div><div class="figure-title">Figure 8-3. MicroSD card shield kit</div></div><div class="figure"><a id="three_stacked_shields_with_an_arduino_un"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00147"/><img src="httpatomoreillycomsourcenostarchimages1630056.png.jpg" alt="Three stacked shields with an Arduino Uno"/></div></div><div class="figure-title">Figure 8-4. Three stacked shields with an Arduino Uno</div></div><div class="warning" title="Warning" epub:type="warning"><h3 class="title"><a id="ch08note01"/>Warning</h3><p><a id="iddle1463" class="indexterm"/><a id="iddle1465" class="indexterm"/><span class="emphasis"><em>When stacking shields, make sure that no shield uses the same digital or analog pins used by another shield at the same time. If you share pins between shields that use the same pin(s) for different functions, you may damage your entire creation, so take care. The supplier of each shield should provide information showing which pins are used by their shields. You can find a great, community-supported list of shields and shield pins used at</em></span> <a class="ulink" href="http://www.shieldlist.org/" target="_top">http://www.shieldlist.org/</a>.</p></div></div><div class="sect1" title="ProtoShields"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="protoshields">ProtoShields</h2></div></div></div><p>You can buy a variety of shields online (at <span class="emphasis"><em><a class="ulink" href="http://www.shieldlist.org/" target="_top">http://www.shieldlist.org/</a></em></span>, for example) or make your own using a ProtoShield. ProtoShields come preassembled or in kit form, similar to the one shown in <a class="xref" href="ch08.html#protoshield_kit" title="Figure 8-5. ProtoShield kit">Figure 8-5</a>.</p><p>A ProtoShield also makes a good base for a solderless breadboard, because it keeps a small circuit within the physical boundary of your Arduino creation (as with the quick-read thermometer shown in <a class="xref" href="ch08.html#quick-read_thermometer_from_project_8" title="Figure 8-6. The quick-read thermometer from Project 8">Figure 8-6</a>). Smaller solderless breadboards fit within the rows of sockets can be attached to the circuit board with Blu-Tack reusable putty for temporary mounting or doublesided tape for more permanent use. ProtoShields can also act as a more permanent foundation for circuits that have been tested on a breadboard.</p><div class="figure"><a id="protoshield_kit"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00148"/><img src="httpatomoreillycomsourcenostarchimages1630058.png.jpg" alt="ProtoShield kit"/></div></div><div class="figure-title">Figure 8-5. ProtoShield kit</div></div><div class="figure"><a id="quick-read_thermometer_from_project_8"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00149"/><img src="httpatomoreillycomsourcenostarchimages1630060.png.jpg" alt="The quick-read thermometer from Project 8"/></div></div><div class="figure-title">Figure 8-6. The quick-read thermometer from Project 8</div></div><p>Building custom circuits on a ProtoShield requires strategic and special planning. This includes designing the circuit, making a schematic, and then planning the layout of the components as they will sit in the ProtoShield. Finally, the completed circuit for your custom shield will be soldered into place, but you should always test it first using a solderless breadboard to ensure that it works. Some ProtoShields come with a PDF schematic file that you can download and print, intended specifically for drawing your project schematic.</p></div><div class="sect1" title="Project #28: Creating a Custom Shield with Eight LEDs"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="project_hash28_creating_a_custom_shield">Project #28: Creating a Custom Shield with Eight LEDs</h2></div></div></div><p><a id="iddle1466" class="indexterm"/>In this project, you’ll create a custom shield containing eight LEDs and current-limiting resistors. This custom shield will make it easy to experiment with LEDs on digital outputs.</p><div class="sect2" title="The Hardware"><div class="titlepage"><div><div><h3 class="title" id="hardware-id00063">The Hardware</h3></div></div></div><p>The following hardware is required for this project:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>One blank Arduino ProtoShield</p></li><li class="listitem"><p>Eight LEDs of any color</p></li><li class="listitem"><p>Eight 560 Ω resistors (R1 to R8)</p></li><li class="listitem"><p>Two 6-pin Arduino stackable headers</p></li><li class="listitem"><p>Two 8-pin Arduino stackable headers</p></li></ul></div></div><div class="sect2" title="The Schematic"><div class="titlepage"><div><div><h3 class="title" id="schematic-id00064">The Schematic</h3></div></div></div><p>The circuit schematic is shown in <a class="xref" href="ch08.html#schematic_for_project_28" title="Figure 8-7. Schematic for Project 28">Figure 8-7</a>.</p><div class="figure"><a id="schematic_for_project_28"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00150"/><img src="httpatomoreillycomsourcenostarchimages1630062.png.jpg" alt="Schematic for Project 28"/></div></div><div class="figure-title">Figure 8-7. Schematic for Project 28</div></div></div><div class="sect2" title="The Layout of the ProtoShield Board"><div class="titlepage"><div><div><h3 class="title" id="layout_of_the_protoshield_board">The Layout of the ProtoShield Board</h3></div></div></div><p>The next step is to learn the layout of the holes on the ProtoShield. The rows and columns of holes on the ProtoShield should match those of the Arduino’s solderless board. On the blank ProtoShield shown in <a class="xref" href="ch08.html#blank_protoshield_shown_from_above" title="Figure 8-8. Blank ProtoShield shown from above">Figure 8-8</a>, the designers have surrounded holes that are electrically connected with black lines.</p><div class="figure"><a id="blank_protoshield_shown_from_above"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00151"/><img src="httpatomoreillycomsourcenostarchimages1630064.png.jpg" alt="Blank ProtoShield shown from above"/></div></div><div class="figure-title">Figure 8-8. Blank ProtoShield shown from above</div></div><p>The long horizontal line below the digital pins is connected to the 5V socket, and the horizontal line above the analog and other pins is connected to GND. The holes between the two lines are insulated from each other. Finally, there are two rows of pins: one at the very top of the ProtoShield and one at the very bottom. The top row consists of two groups of eight pins, and the bottom has two groups of six pins. This is where we solder the stackable headers that allow the ProtoShield to slot into the Arduino board.</p></div><div class="sect2" title="The Design"><div class="titlepage"><div><div><h3 class="title" id="design">The Design</h3></div></div></div><p>Lay out your circuit using graph paper, as shown in <a class="xref" href="ch08.html#planning_our_custom_shield" title="Figure 8-9. Planning our custom shield">Figure 8-9</a>.</p><div class="figure"><a id="planning_our_custom_shield"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00152"/><img src="httpatomoreillycomsourcenostarchimages1630066.png.jpg" alt="Planning our custom shield"/></div></div><div class="figure-title">Figure 8-9. Planning our custom shield</div></div><p><a id="iddle1478" class="indexterm"/><a id="iddle1479" class="indexterm"/>After you’ve drawn a plan for your circuit, test-fit the actual components into the ProtoShield to make sure that they’ll fit and that they aren’t too crowded. If the ProtoShield has space for a reset button, always include one, because the shield will block access to your Arduino’s RESET button.</p></div><div class="sect2" title="Soldering the Components"><div class="titlepage"><div><div><h3 class="title" id="soldering_the_components">Soldering the Components</h3></div></div></div><p>Once you’re satisfied with the layout of the circuit on your ProtoShield and you have tested the circuit to make sure that it works, you can solder the components. Using a soldering iron is not that difficult, and you don’t need to buy an expensive soldering station for this type of work. A simple iron rated at 25–40 watts, like the one shown in <a class="xref" href="ch08.html#soldering_iron" title="Figure 8-10. Soldering iron">Figure 8-10</a>, should do it.</p><div class="figure"><a id="soldering_iron"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00153"/><img src="httpatomoreillycomsourcenostarchimages1630068.png.jpg" alt="Soldering iron"/></div></div><div class="figure-title">Figure 8-10. Soldering iron</div></div><div class="note" title="Note"><h3 class="title"><a id="ch08note02"/>Note</h3><p><span class="emphasis"><em>If soldering is new to you, download and read the instructional comic book from</em></span> <a class="ulink" href="http://mightyohm.com/soldercomic/" target="_top">http://mightyohm.com/soldercomic/</a>.</p></div><p>When soldering the components, you may need to bridge them together with a small amount of solder, as shown in <a class="xref" href="ch08.html#solder_bridge" title="Figure 8-11. Solder bridge">Figure 8-11</a>. As you can see, the end of one resistor is connected to the anode of an LED.</p><p>Check each solder connection as you go, because mistakes are easier to locate and repair <span class="emphasis"><em>before</em></span> the project is finished. When the time comes to solder the four header sockets, keep them aligned using an existing shield to hold the new sockets, as shown in <a class="xref" href="ch08.html#soldering_header_sockets" title="Figure 8-12. Soldering header sockets">Figure 8-12</a>.</p><div class="figure"><a id="solder_bridge"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00154"/><img src="httpatomoreillycomsourcenostarchimages1630070.png.jpg" alt="Solder bridge"/></div></div><div class="figure-title">Figure 8-11. Solder bridge</div></div><div class="figure"><a id="soldering_header_sockets"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00155"/><img src="httpatomoreillycomsourcenostarchimages1630072.png.jpg" alt="Soldering header sockets"/></div></div><div class="figure-title">Figure 8-12. Soldering header sockets</div></div><p><a class="xref" href="ch08.html#completed_custom_shieldexclamation_mark" title="Figure 8-13. Completed custom shield!">Figure 8-13</a> shows the finished product: a custom Arduino shield with eight LEDs.</p><div class="figure"><a id="completed_custom_shieldexclamation_mark"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00156"/><img src="httpatomoreillycomsourcenostarchimages1630074.png.jpg" alt="Completed custom shield!"/></div></div><div class="figure-title">Figure 8-13. Completed custom shield!</div></div></div><div class="sect2" title="Modifying the Custom Shield"><div class="titlepage"><div><div><h3 class="title" id="modifying_the_custom_shield">Modifying the Custom Shield</h3></div></div></div><p><a id="iddle1039" class="indexterm"/><a id="iddle1318" class="indexterm"/>We could use this simple shield in a more complicated project—for example, to monitor the status of digital pins 0 to 7. If we added another six resistors and LEDs, then we could monitor the entire digital output range. There are lots of different ways to use this shield. Just use your imagination!</p></div></div><div class="sect1" title="Expanding Sketches with Libraries"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="expanding_sketches_with_libraries">Expanding Sketches with Libraries</h2></div></div></div><p>Just as an Arduino shield can expand our hardware, a <span class="emphasis"><em>library</em></span> can add useful functions for particular tasks that we can add to our sketches or add extra functions that allow the use of various hardware specific to a manufacturer. Anyone can create a library, just as suppliers of various Arduino shields often write their own libraries to match their hardware.</p><p>The Arduino IDE already includes a set of preinstalled libraries. To include them in your sketches, choose <span class="strong"><strong>Sketch</strong></span> ▸ <span class="strong"><strong>Import Library</strong></span>, and you should see the collection of preinstalled libraries with names such as Ethernet, LiquidCrystal, Servo, and so on. Many of these names will be self-explanatory. (If a library is required in your project work, it will be explained in detail.)</p><div class="sect2" title="Importing a Shield’s Libraries"><div class="titlepage"><div><div><h3 class="title" id="importing_a_shieldapostrophes_libraries">Importing a Shield’s Libraries</h3></div></div></div><p>If you buy a shield, you’ll generally need to download and install its libraries from the shield vendor’s site or from a link provided.</p><p>To demonstrate how this is done, let’s download the library required by the microSD card shield shown in <a class="xref" href="ch08.html#microsd_card_shield_kit" title="Figure 8-3. MicroSD card shield kit">Figure 8-3</a>.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Download the latest file from <span class="emphasis"><em><a class="ulink" href="http://code.google.com/p/sdfatlib/downloads/list/" target="_top">http://code.google.com/p/sdfatlib/downloads/list/</a></em></span>. <a class="xref" href="ch08.html#library_versions_page" title="Figure 8-14. Library versions page">Figure 8-14</a> shows this web page.</p><div class="figure"><a id="library_versions_page"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00157"/><img src="httpatomoreillycomsourcenostarchimages1630076.png.jpg" alt="Library versions page"/></div></div><div class="figure-title">Figure 8-14. Library versions page</div></div></li><li class="listitem"><p>Click the latest version of the library in the list of filenames at the left, which should launch the download page (<a class="xref" href="ch08.html#library_download_page" title="Figure 8-15. Library download page">Figure 8-15</a>).</p><div class="figure"><a id="library_download_page"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00158"/><img src="httpatomoreillycomsourcenostarchimages1630078.png.jpg" alt="Library download page"/></div></div><div class="figure-title">Figure 8-15. Library download page</div></div></li><li class="listitem"><p><a id="iddle1319" class="indexterm"/>Click the filename ending with <span class="emphasis"><em>.zip</em></span>, and the file should start to download. Once you’ve downloaded the library, use the directions that follow to install it on your operating system.</p></li></ol></div><div class="sect3" title="Installing the Library on Mac OS X"><div class="titlepage"><div><div><h4 class="title" id="installing_the_library_on_mac_os_x">Installing the Library on Mac OS X</h4></div></div></div><p>If you’re downloading to the Mac OS X system, follow these directions:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Open the <span class="emphasis"><em>Downloads</em></span> folder on your Mac and find the downloaded <span class="emphasis"><em>.zip</em></span> file, as shown in <a class="xref" href="ch08.html#library_file_in_the_downloads_folder" title="Figure 8-16. Library file in the Downloads folder">Figure 8-16</a>.</p><div class="figure"><a id="library_file_in_the_downloads_folder"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00159"/><img src="httpatomoreillycomsourcenostarchimages1630080.png.jpg" alt="Library file in the Downloads folder"/></div></div><div class="figure-title">Figure 8-16. Library file in the <span class="emphasis"><em>Downloads</em></span> folder</div></div></li><li class="listitem"><p>Double-click the downloaded file’s folder to reveal its contents, and then locate the <span class="emphasis"><em>SdFat</em></span> folder, as shown in <a class="xref" href="ch08.html#downloaded_library_folder" title="Figure 8-17. Downloaded library folder">Figure 8-17</a>.</p><div class="figure"><a id="downloaded_library_folder"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00160"/><img src="httpatomoreillycomsourcenostarchimages1630082.png.jpg" alt="Downloaded library folder"/></div></div><div class="figure-title">Figure 8-17. Downloaded library folder</div></div></li><li class="listitem"><p><a id="iddle1321" class="indexterm"/>Copy the <span class="emphasis"><em>SdFat</em></span> folder from the window shown in <a class="xref" href="ch08.html#downloaded_library_folder" title="Figure 8-17. Downloaded library folder">Figure 8-17</a> to your <span class="emphasis"><em>Arduino/libraries</em></span> folder, as shown in <a class="xref" href="ch08.html#completed_library_installation" title="Figure 8-18. Completed library installation">Figure 8-18</a>.</p><div class="figure"><a id="completed_library_installation"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00161"/><img src="httpatomoreillycomsourcenostarchimages1630084.png.jpg" alt="Completed library installation"/></div></div><div class="figure-title">Figure 8-18. Completed library installation</div></div></li><li class="listitem"><p>Make sure that the <span class="emphasis"><em>SdFat</em></span> library has been installed and is available by restarting the IDE software and selecting <span class="strong"><strong>Sketch</strong></span> ▸ <span class="strong"><strong>Import Library</strong></span>. <span class="emphasis"><em>SdFat</em></span> should show up in the list. (If it does not, try the installation procedure again.)</p></li></ol></div><p>With your library installed, skip forward to <a class="xref" href="ch08.html#microsd_memory_cards" title="MicroSD Memory Cards">MicroSD Memory Cards</a>.</p></div><div class="sect3" title="Installing the Library on Windows XP and Later"><div class="titlepage"><div><div><h4 class="title" id="installing_the_library_on_windows_xp_and">Installing the Library on Windows XP and Later</h4></div></div></div><p>If you’re downloading to a Windows XP or later system, follow these directions:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>After the download has completed, open the downloaded file folder to reveal its contents, and then locate the <span class="emphasis"><em>SdFat</em></span> folder, as shown in <a class="xref" href="ch08.html#downloaded_library_folder-id00065" title="Figure 8-19. Downloaded library folder">Figure 8-19</a>.</p><div class="figure"><a id="downloaded_library_folder-id00065"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00162"/><img src="httpatomoreillycomsourcenostarchimages1630086.png.jpg" alt="Downloaded library folder"/></div></div><div class="figure-title">Figure 8-19. Downloaded library folder</div></div></li><li class="listitem"><p>Copy the <span class="emphasis"><em>SdFat</em></span> folder from the window shown in <a class="xref" href="ch08.html#downloaded_library_folder-id00065" title="Figure 8-19. Downloaded library folder">Figure 8-19</a> to your <span class="emphasis"><em>Arduino/libraries</em></span> folder, as shown in <a class="xref" href="ch08.html#completed_library_installation-id00066" title="Figure 8-20. Completed library installation">Figure 8-20</a>.</p><div class="figure"><a id="completed_library_installation-id00066"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00163"/><img src="httpatomoreillycomsourcenostarchimages1630088.png.jpg" alt="Completed library installation"/></div></div><div class="figure-title">Figure 8-20. Completed library installation</div></div></li><li class="listitem"><p><a id="iddle1320" class="indexterm"/>Make sure that the <span class="emphasis"><em>SdFat</em></span> library has been installed and is available by restarting the IDE and selecting <span class="strong"><strong>Sketch</strong></span> ▸ <span class="strong"><strong>Import Library</strong></span>. <span class="emphasis"><em>SdFat</em></span> should appear in the list. (If it does not, try the installation procedure again from the beginning.)</p></li></ol></div><p>With your library installed, skip forward to <a class="xref" href="ch08.html#microsd_memory_cards" title="MicroSD Memory Cards">MicroSD Memory Cards</a>.</p></div><div class="sect3" title="Installing the Library on Ubuntu Linux 11.04 and Later"><div class="titlepage"><div><div><h4 class="title" id="installing_the_library_on_ubuntu_linux_1">Installing the Library on Ubuntu Linux 11.04 and Later</h4></div></div></div><p>If you’re downloading to a system running Ubuntu Linux 11.04 or later, follow these directions:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Locate the downloaded file and double-click it. The Archive Manager window should appear with the <span class="emphasis"><em>SdFat</em></span> folder, as shown in <a class="xref" href="ch08.html#downloaded_library_folder-id00067" title="Figure 8-21. Downloaded library folder">Figure 8-21</a>.</p><div class="figure"><a id="downloaded_library_folder-id00067"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00164"/><img src="httpatomoreillycomsourcenostarchimages1630090.png.jpg" alt="Downloaded library folder"/></div></div><div class="figure-title">Figure 8-21. Downloaded library folder</div></div></li><li class="listitem"><p><a id="iddle1352" class="indexterm"/>Right-click the <span class="emphasis"><em>SdFat</em></span> folder in the window shown in <a class="xref" href="ch08.html#downloaded_library_folder-id00067" title="Figure 8-21. Downloaded library folder">Figure 8-21</a>, and then click <span class="strong"><strong>Extract</strong></span> to extract it to your <span class="emphasis"><em>/libraries</em></span> folder (<a class="xref" href="ch08.html#destination_for_library_folder" title="Figure 8-22. Destination for library folder">Figure 8-22</a>).</p><div class="figure"><a id="destination_for_library_folder"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00165"/><img src="httpatomoreillycomsourcenostarchimages1630092.png.jpg" alt="Destination for library folder"/></div></div><div class="figure-title">Figure 8-22. Destination for library folder</div></div></li><li class="listitem"><p>Make sure that the <span class="emphasis"><em>SdFat</em></span> library has been installed and is available by restarting the IDE and selecting <span class="strong"><strong>Sketch</strong></span> ▸ <span class="strong"><strong>Import Library</strong></span>. <span class="emphasis"><em>SdFat</em></span> should appear in the list. (If it does not, try the installation procedure again from the beginning.)</p><p>With your library installed, move on to the next section.</p></li></ol></div></div></div></div><div class="sect1" title="MicroSD Memory Cards"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="microsd_memory_cards">MicroSD Memory Cards</h2></div></div></div><p>By using microSD cards with your Arduino, you can capture data from many sources, such as the TMP36 temperature sensor we used in <a class="xref" href="ch04.html" title="Chapter 4. Building Blocks">Chapter 4</a>. You can also use the microSD card to store web server data or any files for your project to use. To record and store the data you collect, you can use a microSD memory card shield like the one shown in <a class="xref" href="ch08.html#microsd_card_with_a_2gb_capacity" title="Figure 8-23. A microSD card with a 2GB capacity">Figure 8-23</a>. This shield uses microSD (not microSDHC) cards with a capacity of up to 2GB.</p><div class="figure"><a id="microsd_card_with_a_2gb_capacity"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00166"/><img src="httpatomoreillycomsourcenostarchimages1630094.png.jpg" alt="A microSD card with a 2GB capacity"/></div></div><div class="figure-title">Figure 8-23. A microSD card with a 2GB capacity</div></div><p>Several memory card shields are available from popular retailers such as SparkFun, Adafruit Industries, and Snootlab. The shield used in this book (shown in <a class="xref" href="ch08.html#microsd_card_shield_kit" title="Figure 8-3. MicroSD card shield kit">Figure 8-3</a>) is from SparkFun (part numbers DEV-09802 and PRT-10007).</p><div class="note" title="Note"><h3 class="title"><a id="ch08note03"/>Note</h3><p><span class="emphasis"><em>Before you can use a memory card with a shield, you need to format it. To do so, plug it into a computer and follow your operating system’s instructions for formatting memory cards. Make sure you use the FAT16 format type. Also, depending on which shield you buy, the sockets may need to be soldered in, following the procedure discussed in <a class="xref" href="ch08.html#soldering_the_components" title="Soldering the Components">Soldering the Components</a>.</em></span></p></div><div class="sect2" title="Testing Your MicroSD Card"><div class="titlepage"><div><div><h3 class="title" id="testing_your_microsd_card">Testing Your MicroSD Card</h3></div></div></div><p>After you have finished formatting and assembling the microSD card shield, make sure that it’s working correctly. To do so, follow these steps:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Connect the shield to your Arduino, and then insert the memory card and plug in the USB cable.</p></li><li class="listitem"><p>Run the IDE by selecting <span class="strong"><strong>File</strong></span> ▸ <span class="strong"><strong>Examples</strong></span> ▸ <span class="strong"><strong>SdFat</strong></span> ▸ <span class="strong"><strong>SdInfo</strong></span>. Then upload the <span class="emphasis"><em>SdInfo</em></span> sketch that appeared in the IDE.</p></li><li class="listitem"><p>Open the Serial Monitor window, set it to 9,600 baud, press any key on the keyboard, and then press <span class="smaller">ENTER</span>. After a moment, you should see some data about the microSD card, as shown in <a class="xref" href="ch08.html#successful_microsd_card_test_results" title="Figure 8-24. Successful microSD card test results">Figure 8-24</a>.</p><div class="figure"><a id="successful_microsd_card_test_results"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00167"/><img src="httpatomoreillycomsourcenostarchimages1630096.png.jpg" alt="Successful microSD card test results"/></div></div><div class="figure-title">Figure 8-24. Successful microSD card test results</div></div></li></ol></div><p><a id="iddle1353" class="indexterm"/>If the test results don’t appear in the Serial Monitor, then try the following until the problem is fixed:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Remove the USB cable from your Arduino, and remove and reinsert the microSD card.</p></li><li class="listitem"><p>Make sure that the header sockets are soldered neatly and that the pins are not shorted out.</p></li><li class="listitem"><p>Check that the Serial Monitor baud rate is 9,600 and that a regular Arduino Uno–compatible board is being used. The Mega and some other board models have the SPI pins in different locations.</p></li><li class="listitem"><p>Reformat your microSD card.</p></li></ul></div></div></div><div class="sect1" title="Project #29: Writing Data to the Memory Card"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="project_hash29_writing_data_to_the_memor">Project #29: Writing Data to the Memory Card</h2></div></div></div><p>To write data to the memory card, connect your shield, insert a microSD card, and then enter and upload the following sketch:</p><a id="pro_id00110"/><pre class="programlisting">  // Project 29 - Writing Data to the Memory Card

  int b = 0;

  #include &lt;SD.h&gt;
  void setup()
  {
    Serial.begin(9600);
    Serial.print("Initializing SD card...");
    pinMode(10, OUTPUT);

    // check that the microSD card exists and is usable
    if (!SD.begin(8))
    {
      Serial.println("Card failed, or not present");
      // stop sketch
      return;
    }
    Serial.println("microSD card is ready");
  }

  void loop()
  {
<span class="gray-background">1</span>   // create the file for writing
    File dataFile = SD.open("DATA.TXT", FILE_WRITE);
    // if the file is ready, write to it:
    if (dataFile)
<span class="gray-background">2</span>   {<span class="strong"><strong/></span>
      for ( int a = 0 ; a &lt; 11 ; a++ )
      {
        dataFile.print(a);
        dataFile.print(" multiplied by two is ");
        b = a * 2;
<span class="gray-background">3</span>       dataFile.println(b, DEC);
<span class="gray-background">4</span>     }
<span class="gray-background">5</span>     dataFile.close(); // close the file once the system has finished with it
                        // (mandatory)
    }
    // if the file isn't ready, show an error:
    else
    {
      Serial.println("error opening DATA.TXT");
<span class="gray-background">6</span>   }<span class="strong"><strong/></span>
    Serial.println("finished");
    do {} while (1);
  }</pre><p>The sketch creates a text file called <span class="emphasis"><em>DATA.txt</em></span> on the microSD card, as shown in <a class="xref" href="ch08.html#output_from_project_29" title="Figure 8-25. Output from Project 29">Figure 8-25</a>.</p><div class="figure"><a id="output_from_project_29"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00168"/><img src="httpatomoreillycomsourcenostarchimages1630098.png.jpg" alt="Output from Project 29"/></div></div><div class="figure-title">Figure 8-25. Output from Project 29</div></div><p>Let’s review the <code class="literal">void loop()</code> section of the sketch to see how it created the text file. The code in <code class="literal">void loop()</code> between <span class="gray-background">1</span> and <span class="gray-background">2</span> and between <span class="gray-background">4</span> and <span class="gray-background">6</span> creates and opens the file for writing. To write text to the file, we use this:</p><a id="pro_id00111"/><pre class="programlisting">dataFile.print(); or dataFile.println();</pre><p>This code works in the same manner as, for example, <code class="literal">Serial.println()</code>, so you can write it in the same manner as you would to the Serial Monitor. At <span class="gray-background">1</span>, we can set the name of the created text file, which must be eight characters, followed by a dot, and then three characters, such as <span class="emphasis"><em>DATA.txt</em></span>.</p><p>At <span class="gray-background">3</span>, we use <code class="literal">DEC</code> as the second parameter. This states that the variable is a decimal number and should be written to the text file as such. If we were writing a <code class="literal">float</code> variable instead, then we would use a digit for the number of decimal places to write (to a maximum of six).</p><p>When finished writing data to the file, at <span class="gray-background">5</span>, we use <code class="literal">dataFile.close()</code> to close the file for writing. If this step is not followed, the computer will not be able to read the created text file.</p></div><div class="sect1" title="Project #30: Creating a Temperature-Logging Device"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="project_hash30_creating_a_temperature-lo">Project #30: Creating a Temperature-Logging Device</h2></div></div></div><p><a id="iddle1508" class="indexterm"/>Now that you know how to record data, let’s measure the temperature every minute for 8 hours using our microSD card shield and the TMP36 temperature sensor that we introduced in <a class="xref" href="ch04.html" title="Chapter 4. Building Blocks">Chapter 4</a>. We’ll combine the functions for writing to the microSD card from Project 29 with temperature measurement from Project 27.</p><div class="sect2" title="The Hardware"><div class="titlepage"><div><div><h3 class="title" id="hardware-id00068">The Hardware</h3></div></div></div><p>The following hardware is required:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>One TMP36 temperature sensor</p></li><li class="listitem"><p>One breadboard</p></li><li class="listitem"><p>Various connecting wires</p></li><li class="listitem"><p>MicroSD card shield and card</p></li><li class="listitem"><p>Arduino and USB cable</p></li></ul></div><p>Insert the microSD card into the shield, and then insert the shield into the Arduino. Connect the left (5V) pin of the TMP36 to Arduino 5V, the middle pin to analog, and the right pin to GND.</p></div><div class="sect2" title="The Sketch"><div class="titlepage"><div><div><h3 class="title" id="sketch-id00069">The Sketch</h3></div></div></div><p>Enter and upload the following sketch:</p><a id="pro_id00112"/><pre class="programlisting">// Project 30 - Creating a Temperature-Logging Device

#include &lt;SD.h&gt;
float sensor, voltage, celsius;

void setup()
{
  Serial.begin(9600);
  Serial.print("Initializing SD card...");
  pinMode(10, OUTPUT);

  // check that the microSD card exists and can be used
  if (!SD.begin(8))
  {
    Serial.println("Card failed, or not present");
    // stop sketch
    return;
  }
  Serial.println("microSD card is ready");
}

void loop()
{
  // create the file for writing
  File dataFile = SD.open("DATA.TXT", FILE_WRITE);
  // if the file is ready, write to it:
  if (dataFile)
  {
    for ( int a = 0 ; a &lt; 481 ; a++ ) // 480 minutes in 8 hours
    {
      sensor = analogRead(0);
      voltage = (sensor * 5000) / 1024; // convert raw sensor value to
                                        // millivolts
      voltage = voltage - 500;
      celsius = voltage / 10;
      dataFile.print(" Log: ");
      dataFile.print(a, DEC);
      dataFile.print(" Temperature: ");
      dataFile.print(celsius, 2);
      dataFile.println(" degrees C");
      delay(599900); // wait just under one minute
    }
    dataFile.close(); // mandatory
    Serial.println("Finished!");
    do {} while (1);
  }
}</pre><p>The sketch will take a little more than 8 hours to complete, but you can alter this time period by lowering the value in <code class="literal">delay(599900)</code>.</p><p>After the sketch has finished, remove the microSD card and open the log file in a text editor, as shown in <a class="xref" href="ch08.html#results_from_project_30" title="Figure 8-26. Results from Project 30">Figure 8-26</a>.</p><div class="figure"><a id="results_from_project_30"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00169"/><img src="httpatomoreillycomsourcenostarchimages1630100.png.jpg" alt="Results from Project 30"/></div></div><div class="figure-title">Figure 8-26. Results from Project 30</div></div><p>For more serious analysis of the captured data, delimit the lines of text written to the log file with spaces or colons so that the file can be easily imported into a spreadsheet. For example, you could import the file into <a id="iddle1351" class="indexterm"/><a id="iddle1356" class="indexterm"/><a id="iddle1518" class="indexterm"/>OpenOffice Calc by choosing <span class="strong"><strong>Insert</strong></span> ▸ <span class="strong"><strong>Sheet From File</strong></span> to produce a spreadsheet like the one shown in <a class="xref" href="ch08.html#importing_data_into_a_spreadsheet" title="Figure 8-27. Importing data into a spreadsheet">Figure 8-27</a>, which you could then analyze the data of, as shown in <a class="xref" href="ch08.html#temperature_analysis" title="Figure 8-28. Temperature analysis">Figure 8-28</a>.</p><div class="figure"><a id="importing_data_into_a_spreadsheet"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00170"/><img src="httpatomoreillycomsourcenostarchimages1630102.png.jpg" alt="Importing data into a spreadsheet"/></div></div><div class="figure-title">Figure 8-27. Importing data into a spreadsheet</div></div><div class="figure"><a id="temperature_analysis"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00171"/><img src="httpatomoreillycomsourcenostarchimages1630104.png.jpg" alt="Temperature analysis"/></div></div><div class="figure-title">Figure 8-28. Temperature analysis</div></div><p>The temperature examples can be hacked to suit your own data analysis projects. You can use these same concepts to record any form of data that can be generated by an Arduino system.</p></div></div><div class="sect1" title="Timing Applications with millis() and micros()"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="timing_applications_with_millisleft_pare">Timing Applications with millis() and micros()</h2></div></div></div><p>Each time the Arduino starts running a sketch, it also records the passage of time using milliseconds and microseconds. A millisecond is one thousandth of a second (0.001), and a microsecond is one millionth of a second (0.000001). You can use these values to measure the passage of time when running sketches.</p><p><a id="iddle1345" class="indexterm"/><a id="iddle1547" class="indexterm"/><a id="iddle1556" class="indexterm"/>The following functions will access the time values stored in an <code class="literal">unsigned long</code> variable:</p><a id="pro_id00113"/><pre class="programlisting">unsigned long a,b;
a = micros();
b = millis();</pre><p>Due to the limitations of the <code class="literal">unsigned long</code> variable type, the value will reset to 0 after reaching 4,294,967,295, allowing for around 50 days of counting for <code class="literal">millis()</code> and 70 minutes in <code class="literal">micros()</code>. Furthermore, due to the limitations of the Arduino’s microprocessor, <code class="literal">micros()</code> values are always in multiples of four.</p><p>Let’s use these values to see how long it takes for the Arduino to turn a digital pin from <code class="literal">LOW</code> to <code class="literal">HIGH</code> and vice versa. To do this, we’ll read <code class="literal">micros()</code> before and after a <code class="literal">digitalWrite()</code> function, find the difference, and display it on the Serial Monitor. The only required hardware is your Arduino and cable.</p><p>Enter and upload the sketch shown in <a class="xref" href="ch08.html#timing_digital_pin_state_change_with_mic" title="Example 8-1. Timing digital pin state change with micros()">Example 8-1</a>.</p><div class="example"><a id="timing_digital_pin_state_change_with_mic"/><div class="example-title">Example 8-1. Timing digital pin state change with <code class="literal">micros()</code></div><div class="example-contents"><pre class="programlisting">  // Listing 8-1

  unsigned long start, finished, elapsed;

  void setup()
  {
    Serial.begin(9600);
    pinMode(3, OUTPUT);
    digitalWrite(3, LOW);
  }

  void loop()
  {
<span class="gray-background">1</span>   start = micros();
    digitalWrite(3, HIGH);
<span class="gray-background">2</span>   finished = micros();
<span class="gray-background">3</span>   elapsed = finished – start;
    Serial.print("LOW to HIGH: ");
    Serial.print(elapsed);
    Serial.println(" microseconds");
    delay(1000);

<span class="gray-background">4</span>   start = micros();
    digitalWrite(3, LOW);
    finished = micros();
    elapsed = finished - start;
    Serial.print("HIGH to LOW: ");
    Serial.print(elapsed);
    Serial.println(" microseconds");
    delay(1000);
  }</pre></div></div><p><a id="iddle1495" class="indexterm"/>The sketch takes readings of <code class="literal">micros()</code> before and after the <code class="literal">digitalWrite(HIGH)</code> functions at <span class="gray-background">1</span> and <span class="gray-background">2</span>, and then it calculates the difference and displays it on the Serial Monitor at <span class="gray-background">3</span>. This is repeated for the opposite function at <span class="gray-background">4</span>.</p><p>Now open the Serial Monitor to view the results, shown in <a class="xref" href="ch08.html#output_from_listing_8-1" title="Figure 8-29. Output from Example 8-1">Figure 8-29</a>.</p><div class="figure"><a id="output_from_listing_8-1"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00172"/><img src="httpatomoreillycomsourcenostarchimages1630106.png.jpg" alt="Output from"/></div></div><div class="figure-title">Figure 8-29. Output from <a class="xref" href="ch08.html#timing_digital_pin_state_change_with_mic" title="Example 8-1. Timing digital pin state change with micros()">Example 8-1</a></div></div><p>Because the resolution is 4 microseconds, if the value is 8 microseconds, then we know that the duration is greater than 4 and less than or equal to 8.</p></div><div class="sect1" title="Project #31: Creating a Stopwatch"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="project_hash31_creating_a_stopwatch">Project #31: Creating a Stopwatch</h2></div></div></div><p>Now that we can measure the elapsed time between two events, we can create a simple stopwatch using an Arduino. Our stopwatch will use two buttons: one to start or reset the count and another to stop counting and show the elapsed time. The sketch will continually check the status of the two buttons. When the start button is pressed, a <code class="literal">millis()</code> value will be stored, and when the second button is pressed, a new <code class="literal">millis()</code> value will be stored. The custom function <code class="literal">displayResult()</code> will convert the elapsed time from milliseconds into hours, minutes, and seconds. Finally, the time will be displayed on the Serial Monitor.</p><div class="sect2" title="The Hardware"><div class="titlepage"><div><div><h3 class="title" id="hardware-id00070">The Hardware</h3></div></div></div><p>The following hardware is required for this project:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>One breadboard</p></li><li class="listitem"><p>Two push buttons (S1 and S2)</p></li><li class="listitem"><p>Two 10 kΩ resistors (R1 and R2)</p></li><li class="listitem"><p>Various connecting wires</p></li><li class="listitem"><p>Arduino and USB cable</p></li></ul></div></div><div class="sect2" title="The Schematic"><div class="titlepage"><div><div><h3 class="title" id="schematic-id00071">The Schematic</h3></div></div></div><p>The circuit schematic is shown in <a class="xref" href="ch08.html#schematic_for_project_31" title="Figure 8-30. Schematic for Project 31">Figure 8-30</a>.</p><div class="note" title="Note"><h3 class="title"><a id="ch08note04"/>Note</h3><p><span class="emphasis"><em>You will use this circuit for the next project, so don’t pull it apart when you’re finished!</em></span></p></div><div class="figure"><a id="schematic_for_project_31"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00173"/><img src="httpatomoreillycomsourcenostarchimages1630108.png.jpg" alt="Schematic for Project 31"/></div></div><div class="figure-title">Figure 8-30. Schematic for Project 31</div></div></div><div class="sect2" title="The Sketch"><div class="titlepage"><div><div><h3 class="title" id="sketch-id00072">The Sketch</h3></div></div></div><p>Enter and upload this sketch:</p><a id="pro_id00114"/><pre class="programlisting">  // Project 31 – Creating a Stopwatch

  unsigned long start, finished, elapsed;

  void setup()
  {
    Serial.begin(9600);
<span class="gray-background">1</span>   pinMode(2, INPUT); // the start button
    pinMode(3, INPUT); // the stop button
    Serial.println("Press 1 for Start/reset, 2 for elapsed time");
  }

  void displayResult()
  {
    float h, m, s, ms;
    unsigned long over;

<span class="gray-background">2</span>   elapsed = finished - start;

    h    = int(elapsed / 3600000);
    over = elapsed % 3600000;
    m    = int(over / 60000);
    over = over % 60000;
    s    = int(over / 1000);
    ms   = over % 1000;

    Serial.print("Raw elapsed time: ");
    Serial.println(elapsed);
    Serial.print("Elapsed time: ");
    Serial.print(h, 0);
    Serial.print("h ");
    Serial.print(m, 0);
    Serial.print("m ");
    Serial.print(s, 0);
    Serial.print("s ");
    Serial.print(ms, 0);
    Serial.println("ms");
    Serial.println();
  }

  void loop()
  {
<span class="gray-background">3</span>   if (digitalRead(2) == HIGH)
    {
      start = millis();
      delay(200); // for debounce
      Serial.println("Started...");
    }
<span class="gray-background">4</span>   if (digitalRead(3) == HIGH)
    {
      finished = millis();
      delay(200); // for debounce
      displayResult();
    }
  }</pre><p>The basis for our stopwatch is simple. At <span class="gray-background">1</span>, we set up the digital input pins for the start and stop buttons. At <span class="gray-background">3</span>, if the start button is pressed, then the Arduino notes the value for <code class="literal">millis()</code> that we use to calculate the elapsed time once the stop button is pressed at <span class="gray-background">4</span>. After the stop button is pressed, the elapsed time is calculated in the function <code class="literal">displayResult()</code> at <span class="gray-background">2</span> and shown in the Serial Monitor window.</p><div class="figure"><a id="output_from_project_31"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00174"/><img src="httpatomoreillycomsourcenostarchimages1630110.png.jpg" alt="Output from Project 31"/></div></div><div class="figure-title">Figure 8-31. Output from Project 31</div></div><p>The results shown in <a class="xref" href="ch08.html#output_from_project_31" title="Figure 8-31. Output from Project 31">Figure 8-31</a> should appear in the Serial Monitor.</p></div></div><div class="sect1" title="Interrupts"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="interrupts">Interrupts</h2></div></div></div><p><a id="iddle1300" class="indexterm"/><a id="iddle1301" class="indexterm"/>An <span class="emphasis"><em>interrupt</em></span> in the Arduino world is basically a signal that allows a function to be called at any time within a sketch—for example, when a digital input pin’s state changes or a timer event is triggered. Interrupts are perfect for calling a function to interrupt the normal operation of a sketch, such as when a button is pressed.</p><p>When an interrupt is triggered, the normal operation and running of your program in the <code class="literal">void loop()</code> is halted temporarily, the interrupt function is called and executed, and then when the interrupt function exits, whatever was happening in the main loop starts exactly from where it left off.</p><p>Keep in mind that interrupt functions should be short and usually simple. They should exit quickly, and if the interrupt function does something that the main loop may already be doing, then the interrupt function is temporarily going to override whatever the main loop was doing. For example, if the main loop is regularly sending <span class="emphasis"><em>Hello</em></span> out the serial port and the interrupt function sends <span class="emphasis"><em>---</em></span> when it is triggered, then you will see any of these come out the serial port: <span class="emphasis"><em>H----ello</em></span>, <span class="emphasis"><em>He----llo</em></span>, <span class="emphasis"><em>Hel----lo</em></span>, <span class="emphasis"><em>Hell----o</em></span>, or <span class="emphasis"><em>Hello----</em></span>.</p><p>The Arduino Uno offers two interrupts that are available using digital pins 2 and 3. When properly configured, the Arduino will monitor the voltage applied to the pins. When the voltage changes in a certain, defined way (when a button is pressed, for example), an interrupt is triggered, causing a corresponding function to run—maybe something like “Stop Pressing Me!”</p><div class="sect2" title="Interrupt Modes"><div class="titlepage"><div><div><h3 class="title" id="interrupt_modes">Interrupt Modes</h3></div></div></div><p>One of four changes (or <span class="emphasis"><em>modes</em></span>) can trigger an interrupt:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p><code class="literal">LOW</code>: No current is applied to the interrupt pin.</p></li><li class="listitem"><p><code class="literal">CHANGE</code>: The current changes, either between on and off or between off and on.</p></li><li class="listitem"><p><code class="literal">RISING</code>: The current changes from off to on at 5 V.</p></li><li class="listitem"><p><code class="literal">FALLING</code>: The current changes from on at 5 V to off.</p></li></ul></div><p>For example, to detect when a button attached to an interrupt pin has been pressed, we could use the <code class="literal">RISING</code> mode. Or, for example, if you had an electric trip wire running around your garden (connected between 5 V and the interrupt pin), then you could use the <code class="literal">FALLING</code> mode to detect when the wire has been tripped and broken.</p><div class="note" title="Note"><h3 class="title"><a id="ch08note05"/>Note</h3><p><span class="emphasis"><em>The <code class="literal">delay()</code> and <code class="literal">Serial.available()</code> functions will not work within a function that has been called by an interrupt.</em></span></p></div></div><div class="sect2" title="Configuring Interrupts"><div class="titlepage"><div><div><h3 class="title" id="configuring_interrupts">Configuring Interrupts</h3></div></div></div><p><a id="iddle1083" class="indexterm"/><a id="iddle1302" class="indexterm"/><a id="iddle1367" class="indexterm"/>To configure interrupts, use the following in <code class="literal">void setup()</code>:</p><a id="pro_id00115"/><pre class="programlisting">attachInterrupt(0, function, mode);
attachInterrupt(1, function, mode);</pre><p>Here, <code class="literal">0</code> is for digital pin 2, <code class="literal">1</code> is for digital pin 3, <code class="literal">function</code> is the name of the function to call when the interrupt is triggered, and <code class="literal">mode</code> is one of the four modes that triggers the interrupt.</p></div><div class="sect2" title="Activating or Deactivating Interrupts"><div class="titlepage"><div><div><h3 class="title" id="activating_or_deactivating_interrupts">Activating or Deactivating Interrupts</h3></div></div></div><p>Sometimes within a sketch you won’t want to use the interrupts. Deactivate them using the following:</p><a id="pro_id00116"/><pre class="programlisting">noInterrupts(); // deactivate interrupts</pre><p>And then reactivate them with this:</p><a id="pro_id00117"/><pre class="programlisting">interrupts(); // reactivate interrupts</pre><p>Interrupts work quickly and they are very sensitive, which makes them useful for time-critical applications or for “emergency stop” buttons on projects.</p></div></div><div class="sect1" title="Project #32: Using Interrupts"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="project_hash32_using_interrupts">Project #32: Using Interrupts</h2></div></div></div><p>We’ll use the circuit from Project 31 to demonstrate the use of interrupts. Our example will blink the built-in LED every 500 milliseconds, during which time both interrupt pins will be monitored. When the button on interrupt 0 is pressed, the value for <code class="literal">micros()</code> will be displayed on the Serial Monitor, and when the button on interrupt 1 is pressed, the value for <code class="literal">millis()</code> will be displayed.</p><div class="sect2" title="The Sketch"><div class="titlepage"><div><div><h3 class="title" id="sketch-id00073">The Sketch</h3></div></div></div><p>Enter and upload the following sketch:</p><a id="pro_id00118"/><pre class="programlisting">  // Project 32 – Using Interrupts

  #define LED 13
  void setup()
  {
    Serial.begin(9600);
    pinMode(13, OUTPUT);
    attachInterrupt(0, displayMicros, RISING);
    attachInterrupt(1, displayMillis, RISING);
  }
<span class="gray-background">1</span> void displayMicros()
  {
    Serial.write("micros() = ");
    Serial.println(micros());
  }

<span class="gray-background">2</span><span class="strong"><strong/></span> void displayMillis()
  {
    Serial.write("millis() = ");
    Serial.println(millis());
  }

<span class="gray-background">3</span> void loop()
  {
    digitalWrite(LED, HIGH);
    delay(500);
    digitalWrite(LED, LOW);
    delay(500);
  }</pre><p>This sketch will blink the onboard LED as shown in <code class="literal">void loop()</code> at <span class="gray-background">3</span>. When interrupt 0 is triggered, the function <code class="literal">displayMicros()</code> at <span class="gray-background">1</span> will be called; or when interrupt 1 is triggered, the function <code class="literal">displayMillis()</code> at <span class="gray-background">2</span> will be called. After either function has finished, the sketch resumes running the code in <code class="literal">void loop</code>.</p><p>Open the Serial Monitor window and press the two buttons to view the values for <code class="literal">millis()</code> and <code class="literal">micros()</code> as shown in <a class="xref" href="ch08.html#output_from_project_32" title="Figure 8-32. Output from Project 32">Figure 8-32</a>.</p><div class="figure"><a id="output_from_project_32"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00175"/><img src="httpatomoreillycomsourcenostarchimages1630112.png.jpg" alt="Output from Project 32"/></div></div><div class="figure-title">Figure 8-32. Output from Project 32</div></div></div></div><div class="sect1" title="Looking Ahead"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="looking_ahead-id00074">Looking Ahead</h2></div></div></div><p>This chapter has given you more tools and options that you can adapt to create and improve your own projects. In future chapters, we will work with more Arduino shields and use the microSD card shield in other datalogging applications.</p></div></section></body></html>
