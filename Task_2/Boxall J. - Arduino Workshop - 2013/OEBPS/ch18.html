<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:pls="http://www.w3.org/2005/01/pronunciation-lexicon" xmlns:ssml="http://www.w3.org/2001/10/synthesis" xmlns:svg="http://www.w3.org/2000/svg"><head><title>Chapter 18. Real-time Clocks</title><link rel="stylesheet" type="text/css" href="core.css"/><meta name="generator" content="DocBook XSL Stylesheets V1.76.1"/><link rel="up" href="index.html" title="Arduino Workshop: A hands-on introduction with 65 projects"/><link rel="prev" href="ch17.html" title="Chapter 17. Data Buses"/><link rel="next" href="ch19.html" title="Chapter 19. The Internet"/></head><body><section class="chapter" title="Chapter 18. Real-time Clocks" epub:type="chapter" id="real-time_clocks"><div class="titlepage"><div><div><h2 class="title">Chapter 18. Real-time Clocks</h2></div></div></div><p><a id="iddle1159" class="indexterm"/><a id="iddle1179" class="indexterm"/><a id="iddle1519" class="indexterm"/>In this chapter you will</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Set and retrieve the time and date from a real-time clock module</p></li><li class="listitem"><p>Discover new ways to connect devices to an Arduino</p></li><li class="listitem"><p>Create a digital clock</p></li><li class="listitem"><p>Build an employee RFID time clock</p></li></ul></div><p>A <span class="emphasis"><em>real-time clock (RTC)</em></span> IC module is a small timekeeping device that opens all sorts of possibilities for Arduino projects. Once set with the current time and date, an RTC provides accurate time and date data on request.</p><p>You’ll find many different RTC ICs on the market, some more accurate than others. In this chapter, we’ll use the Maxim DS3232; it doesn’t require any external circuitry other than a backup battery, and it’s incredibly accurate and quite robust in module form. The DS3232 is available as a breakout board from various retailers, including the version from Freetronics (<span class="emphasis"><em><a class="ulink" href="http://www.freetronics.com/rtc/" target="_top">http://www.freetronics.com/rtc/</a></em></span>) that is shown in <a class="xref" href="ch18.html#real-time_clock_ic_module" title="Figure 18-1. Real-time clock IC module">Figure 18-1</a>.</p><div class="figure"><a id="real-time_clock_ic_module"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00284"/><img src="httpatomoreillycomsourcenostarchimages1630338.png.jpg" alt="Real-time clock IC module"/></div></div><div class="figure-title">Figure 18-1. Real-time clock IC module</div></div><div class="sect1" title="Connecting the RTC Module"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="connecting_the_rtc_module">Connecting the RTC Module</h2></div></div></div><p><a id="iddle1125" class="indexterm"/><a id="iddle1146" class="indexterm"/><a id="iddle1225" class="indexterm"/><a id="iddle1267" class="indexterm"/><a id="iddle1348" class="indexterm"/><a id="iddle1411" class="indexterm"/><a id="iddle1412" class="indexterm"/><a id="iddle1432" class="indexterm"/><a id="iddle1517" class="indexterm"/>It’s easy to connect the RTC module to an Arduino, because it uses the I<sup>2</sup>C bus (discussed in <a class="xref" href="ch17.html" title="Chapter 17. Data Buses">Chapter 17</a>). All you need are four wires: GND and VCC go to Arduino GND and 5V, respectively; SDA and SCL go to Arduino A4 and A5, respectively. Due to the module’s design, no extra pull-up resistors are required on the I<sup>2</sup>C bus, unless you have a long cable between the module and your Arduino. If so, solder across the pads on the underside marked “Pullups: SDA and SCL” to enable the built-in I<sup>2</sup>C pull-up resistors.</p><p>For convenience, consider mounting the module on a blank ProtoShield so it can be integrated easily with other hardware for other projects. And make sure you have the backup battery installed, or your time data will be lost when you turn off the project!</p></div><div class="sect1" title="Project #57: Adding and Displaying Time and Date with an RTC"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="project_hash57_adding_and_displaying_tim">Project #57: Adding and Displaying Time and Date with an RTC</h2></div></div></div><p>In this project you’ll learn how to set the time and date on the RTC and then retrieve and display it in the Serial Monitor. Time and date information can be useful for various types of projects, such as temperature loggers and alarm clocks.</p><div class="sect2" title="The Hardware"><div class="titlepage"><div><div><h3 class="title" id="hardware-id00147">The Hardware</h3></div></div></div><p>Here’s what you’ll need to create this project:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Arduino and USB cable</p></li><li class="listitem"><p>Various connecting wires</p></li><li class="listitem"><p>Maxim DS3232 RTC module</p></li></ul></div></div><div class="sect2" title="The Sketch"><div class="titlepage"><div><div><h3 class="title" id="sketch-id00148">The Sketch</h3></div></div></div><p>Connect the module to the Arduino as described earlier in the chapter, and then enter but <span class="emphasis"><em>do not upload</em></span> the following sketch:</p><a id="pro_id00166"/><pre class="programlisting">  // Project 57 - Adding and Displaying Time and Date with an RTC

<span class="gray-background">1</span> #include "Wire.h"
  #define DS3232_I2C_ADDRESS 0x68

  // Convert normal decimal numbers to binary coded decimal
<span class="gray-background">2</span> byte decToBcd(byte val)
  {
    return( (val/10*16) + (val%10) );
  }

  // Convert binary coded decimal to normal decimal numbers
  byte bcdToDec(byte val)
  {
    return( (val/16*10) + (val%16) );
  }

  void setup()
  {
    Wire.begin();
    Serial.begin(9600);

    // set the initial time here:
    // DS3232 seconds, minutes, hours, day, date, month, year
<span class="gray-background">3</span>   setDS3232time(0, 56, 23, 3, 30, 10, 12);

  }

<span class="gray-background">4</span> void setDS3232time(byte second, byte minute, byte hour, byte dayOfWeek, byte
  dayOfMonth, byte month, byte year)
  {
    // sets time and date data to DS3232
    Wire.beginTransmission(DS3232_I2C_ADDRESS);
    Wire.write(0); // set next input to start at the seconds register
    Wire.write(decToBcd(second));     // set seconds
    Wire.write(decToBcd(minute));     // set minutes
    Wire.write(decToBcd(hour));       // set hours
    Wire.write(decToBcd(dayOfWeek));  // set day of week (1=Sunday, 7=Saturday)
    Wire.write(decToBcd(dayOfMonth)); // set date (1 to 31)
    Wire.write(decToBcd(month));      // set month
    Wire.write(decToBcd(year));       // set year (0 to 99)
    Wire.endTransmission();
  }

<span class="gray-background">5</span> void readDS3232time(byte *second,
  byte *minute,
  byte *hour,
  byte *dayOfWeek,
  byte *dayOfMonth,
  byte *month,
  byte *year)
  {
    Wire.beginTransmission(DS3232_I2C_ADDRESS);
    Wire.write(0); // set DS3232 register pointer to 00h
    Wire.endTransmission();
    Wire.requestFrom(DS3232_I2C_ADDRESS, 7);

    // request seven bytes of data from DS3232 starting from register 00h
    *second     = bcdToDec(Wire.read() &amp; 0x7f);
    *minute     = bcdToDec(Wire.read());
    *hour       = bcdToDec(Wire.read() &amp; 0x3f);
    *dayOfWeek  = bcdToDec(Wire.read());
    *dayOfMonth = bcdToDec(Wire.read());
    *month      = bcdToDec(Wire.read());
    *year       = bcdToDec(Wire.read());
  }

  void displayTime()
  {
    byte second, minute, hour, dayOfWeek, dayOfMonth, month, year;

    // retrieve data from DS3232 
<span class="gray-background">6</span>   readDS3232time(&amp;second, &amp;minute, &amp;hour, &amp;dayOfWeek, &amp;dayOfMonth, &amp;month,
    &amp;year);

    // send it to the serial monitor
    Serial.print(hour, DEC);
    // convert the byte variable to a decimal number when displayed
    Serial.print(":");
    if (minute&lt;10)
    {
        Serial.print("0");
    }
    Serial.print(minute, DEC);
    Serial.print(":");
    if (second&lt;10)
    {
        Serial.print("0");
    }
    Serial.print(second, DEC);
    Serial.print("  ");
    Serial.print(dayOfMonth, DEC);
    Serial.print("/");
    Serial.print(month, DEC);
    Serial.print("/");
    Serial.print(year, DEC);
    Serial.print("  Day of week: ");
    switch(dayOfWeek){
    case 1:
      Serial.println("Sunday");
      break;
    case 2:
      Serial.println("Monday");
      break;
    case 3:
      Serial.println("Tuesday");
      break;
    case 4:
      Serial.println("Wednesday");
      break;
    case 5:
      Serial.println("Thursday");
      break;
    case 6:
      Serial.println("Friday");
      break;
    case 7:
      Serial.println("Saturday");
      break;
    }
  }

  void loop()
  {
     displayTime(); // display the real-time clock data on the Serial Monitor,
     delay(1000);   // every second
  }</pre></div><div class="sect2" title="How It Works"><div class="titlepage"><div><div><h3 class="title" id="how_it_works-id00149">How It Works</h3></div></div></div><p><a id="iddle1414" class="indexterm"/>This sketch might look complex, but it’s really not so difficult. At <span class="gray-background">1</span>, we import the I<sup>2</sup>C library and set the bus address of the RTC in the sketch as <code class="literal">0x68</code>. At <span class="gray-background">2</span>, two custom functions convert decimal numbers to binary-coded decimal (BCD) values and return those values. We perform these conversions because the DS3232 stores values in BCD format.</p><p>At <span class="gray-background">3</span>, we use the function <code class="literal">setDS3232time</code> to pass the time and date information to the RTC IC like this:</p><a id="pro_id00167"/><pre class="programlisting">setDS3232time(<span class="emphasis"><em>second</em></span>, <span class="emphasis"><em>minute</em></span>, <span class="emphasis"><em>hour</em></span>, <span class="emphasis"><em>dayOfWeek</em></span>, <span class="emphasis"><em>dayOfMonth</em></span>, <span class="emphasis"><em>month</em></span>, <span class="emphasis"><em>year</em></span>)</pre><p>To use this function, simply insert the required data into the various parameters. The <span class="emphasis"><em><code class="literal">dayOfWeek</code></em></span> parameter is a number between 1 and 7 representing Sunday through Saturday, respectively. The information for <span class="emphasis"><em><code class="literal">year</code></em></span> is only two digits—for example, you’d use <code class="literal">13</code> for the year 2013. (The 20 is assumed.) You can insert either fixed values (as in this sketch) or byte variables that contain the parameters.</p><p>Thus, to set the time in the RTC, we enter the current date and time values into the <code class="literal">setDS3232time</code> function at <span class="gray-background">4</span>. Now you can upload the sketch. Having done that once, we comment out the function by placing <code class="literal">//</code> in front of the <code class="literal">setDS3232time</code> function at <span class="gray-background">4</span>, and then we re-upload the sketch to ensure that the time isn’t set to the original value every time the sketch starts!</p><p><a id="iddle1413" class="indexterm"/>Finally, the function <code class="literal">readDS3232time</code> at <span class="gray-background">5</span> reads the time and date from the RTC and inserts the data into byte variables. This is used at <span class="gray-background">6</span> inside the function <code class="literal">displayTime</code>, which simply retrieves the data and displays it in the Serial Monitor by printing the contents of the time variables.</p><p>Now upload your sketch and open the Serial Monitor. The results should look similar to those shown in <a class="xref" href="ch18.html#results_from_project_57" title="Figure 18-2. Results from Project 57">Figure 18-2</a>.</p><div class="figure"><a id="results_from_project_57"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00285"/><img src="httpatomoreillycomsourcenostarchimages1630340.png.jpg" alt="Results from Project 57"/></div></div><div class="figure-title">Figure 18-2. Results from Project 57</div></div><p>You can use the contents of the sketch for Project 57 as a basis for other time-related projects. The functions <code class="literal">decToBcd</code>, <code class="literal">bcdToDec</code>, <code class="literal">readDS3232time</code>, and <code class="literal">setDS3232time</code> can be inserted and thus reused in future projects. That’s one of the benefits of using the Arduino platform: Once you write a useful procedure, it can often be reused later with little or no modification.</p></div></div><div class="sect1" title="Project #58: Creating a Simple Digital Clock"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="project_hash58_creating_a_simple_digital">Project #58: Creating a Simple Digital Clock</h2></div></div></div><p>In this project we’ll use the functions from Project 57 to display the time and date on a standard character LCD, similar to the one used in the GPS receiver in Project 44.</p><div class="sect2" title="The Hardware"><div class="titlepage"><div><div><h3 class="title" id="hardware-id00150">The Hardware</h3></div></div></div><p>Here’s what you’ll need to create this project:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Arduino and USB cable</p></li><li class="listitem"><p>Various connecting wires</p></li><li class="listitem"><p>One breadboard</p></li><li class="listitem"><p>ProtoScrewShield or similar product</p></li><li class="listitem"><p>LCD module or Freetronics LCD shield</p></li><li class="listitem"><p>Real-time clock module (shown earlier in the chapter)</p></li></ul></div><p>First, re-create the hardware used in Project 57. If you connected the RTC module with wires into the Arduino, use a ProtoScrewShield instead to interface with the RTC. Then insert your LCD shield on top of the other shields.</p><div class="sidebar"><a id="protoscrewshield"/><div class="sidebar-title">ProtoScrewShield</div><p><a id="iddle1390" class="indexterm"/>Over time, your projects may consist of several Arduino shields and external devices, all connected by a mess of wires. A great way to control the mess is the ProtoScrewShield for Arduino from Wingshield Industries (<span class="emphasis"><em><a class="ulink" href="http://wingshieldindustries.com/" target="_top">http://wingshieldindustries.com/</a></em></span>), as shown in <a class="xref" href="ch18.html#protoscrewshield_in_use" title="Figure 18-3. The ProtoScrewShield in use">Figure 18-3</a>.</p><div class="figure"><a id="protoscrewshield_in_use"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00286"/><img src="httpatomoreillycomsourcenostarchimages1630342.png.jpg" alt="The ProtoScrewShield in use"/></div></div><div class="figure-title">Figure 18-3. The ProtoScrewShield in use</div></div><p>This component comprises two parts, one for each row of sockets on the Arduino. Once you insert the component into the Arduino, you can continue using shields. However, you can also connect wires from external devices such as sensors or servos directly to the Arduino I/O pins via the screw terminals on the ProtoScrewShield.</p></div></div><div class="sect2" title="The Sketch"><div class="titlepage"><div><div><h3 class="title" id="sketch-id00151">The Sketch</h3></div></div></div><p>Enter but <span class="emphasis"><em>do not upload</em></span> the following sketch:</p><a id="pro_id00168"/><pre class="programlisting">  // Project 58 - Creating a Simple Digital Clock

  #include "Wire.h"
  #define DS3232_I2C_ADDRESS 0x68

<span class="gray-background">1</span> #include &lt;LiquidCrystal.h&gt;
  LiquidCrystal lcd( 8, 9, 4, 5, 6, 7 );

  // Convert normal decimal numbers to binary coded decimal
  byte decToBcd(byte val)
  {
    return( (val/10*16) + (val%10) );
  }

  // Convert binary coded decimal to normal decimal numbers
  byte bcdToDec(byte val)
  {
    return( (val/16*10) + (val%16) );
  }

  void setup()
  {
    Wire.begin();
<span class="gray-background">2</span>   lcd.begin(16, 2);
    // set the initial time here:
    // DS3232 seconds, minutes, hours, day, date, month, year
<span class="gray-background">3</span>   //setDS3232time(0, 27, 0, 5, 15, 11, 12);
  }

  void setDS3232time(byte second, byte minute, byte hour, byte dayOfWeek, byte dayOfMonth, byte month, byte year)
  {
    // sets time and date data to DS3232
    Wire.beginTransmission(DS3232_I2C_ADDRESS);
    Wire.write(0);  // set next input to start at the seconds register
    Wire.write(decToBcd(second));     // set seconds
    Wire.write(decToBcd(minute));     // set minutes
    Wire.write(decToBcd(hour));       // set hours
    Wire.write(decToBcd(dayOfWeek));  // set day of week (1=Sunday, 7=Saturday)
    Wire.write(decToBcd(dayOfMonth)); // set date (1 to 31)
    Wire.write(decToBcd(month));      // set month
    Wire.write(decToBcd(year));       // set year (0 to 99)
    Wire.endTransmission();
  }

  void readDS3232time(byte *second,
  byte *minute,
  byte *hour,
  byte *dayOfWeek,
  byte *dayOfMonth,
  byte *month,
  byte *year)
  {
    Wire.beginTransmission(DS3232_I2C_ADDRESS);
    Wire.write(0); // set DS3232 register pointer to 00h
    Wire.endTransmission();
    Wire.requestFrom(DS3232_I2C_ADDRESS, 7);

    // request seven bytes of data from DS3232 starting from register 00h
    *second     = bcdToDec(Wire.read() &amp; 0x7f);
    *minute     = bcdToDec(Wire.read());
    *hour       = bcdToDec(Wire.read() &amp; 0x3f);
    *dayOfWeek  = bcdToDec(Wire.read());
    *dayOfMonth = bcdToDec(Wire.read());
    *month      = bcdToDec(Wire.read());
    *year       = bcdToDec(Wire.read());
  }

  void displayTime()
  {
    byte second, minute, hour, dayOfWeek, dayOfMonth, month, year;

  // retrieve data from DS3232
    readDS3232time(&amp;second, &amp;minute, &amp;hour, &amp;dayOfWeek, &amp;dayOfMonth, &amp;month,
    &amp;year);

    // send the data to the LCD shield
    lcd.clear();
    lcd.setCursor(4,0);
    lcd.print(hour, DEC);
    lcd.print(":");
    if (minute&lt;10)
    {
      lcd.print("0");
    }
    lcd.print(minute, DEC);
    lcd.print(":");
    if (second&lt;10)
    {
      lcd.print("0");
    }
    lcd.print(second, DEC);

    lcd.setCursor(0,1);
    switch(dayOfWeek){
    case 1:
      lcd.print("Sun");
      break;
    case 2:
      lcd.print("Mon");
      break;
    case 3:
      lcd.print("Tue");
      break;
    case 4:
      lcd.print("Wed");
      break;
    case 5:
      lcd.print("Thu");
      break;
    case 6:
      lcd.print("Fri");
      break;
    case 7:
      lcd.print("Sat");
      break;
    }
    lcd.print(" ");
    lcd.print(dayOfMonth, DEC);
    lcd.print("/");
    lcd.print(month, DEC);
    lcd.print("/");
    lcd.print(year, DEC);
  }

  void loop()
  {
     displayTime(); // display the real-time clock time on the LCD,
     delay(1000);   // every second
  }</pre></div><div class="sect2" title="How It Works and Results"><div class="titlepage"><div><div><h3 class="title" id="how_it_works_and_results">How It Works and Results</h3></div></div></div><p><a id="iddle1214" class="indexterm"/><a id="iddle1462" class="indexterm"/><a id="iddle1407" class="indexterm"/>The operation of this sketch is similar to that of Project 57, except in this case, we’ve altered the function <code class="literal">displayTime</code> to send time and date data to the LCD instead of to the Serial Monitor, and we’ve added the setup lines required for the LCD at <span class="gray-background">1</span> and <span class="gray-background">2</span>. (For a refresher on using the LCD module, see <a class="xref" href="ch07.html" title="Chapter 7. Liquid Crystal Displays">Chapter 7</a>.) Don’t forget to upload the sketch first with the time and date data entered at <span class="gray-background">3</span>, and then re-upload the sketch with that point commented out. After uploading the sketch, your results should be similar to those shown in <a class="xref" href="ch18.html#display_from_project_58" title="Figure 18-4. Display from Project 58">Figure 18-4</a>.</p><div class="figure"><a id="display_from_project_58"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00287"/><img src="httpatomoreillycomsourcenostarchimages1630344.png.jpg" alt="Display from Project 58"/></div></div><div class="figure-title">Figure 18-4. Display from Project 58</div></div><p>Now that you’ve worked through Projects 57 and 58, you should have a sense of how to read and write data to and from the RTC IC in your sketches. Now let’s use what you’ve learned so far to create something really useful.</p></div></div><div class="sect1" title="Project #59: Creating an RFID Time-Clock System"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="project_hash59_creating_an_rfid_time-clo">Project #59: Creating an RFID Time-Clock System</h2></div></div></div><p>In this project we’ll create a time-clock system. You’ll see how Arduino shields can work together and how the ProtoScrewShield helps you introduce electronic parts that aren’t mounted on a shield. This system can be used by two people who are assigned an RFID card or tag that they’ll swipe over an RFID reader when they enter or leave an area (such as the workplace or a home). The time and card details will be recorded to a microSD card for later analysis.</p><p>We covered logging data to a microSD card in <a class="xref" href="ch13.html" title="Chapter 13. Using GPS with Your Arduino">Chapter 13</a>, to the RFID in <a class="xref" href="ch16.html" title="Chapter 16. Reading RFID Tags">Chapter 16</a>, and to the RTC earlier in this chapter. Now we’ll put the pieces together.</p><div class="sect2" title="The Hardware"><div class="titlepage"><div><div><h3 class="title" id="hardware-id00152">The Hardware</h3></div></div></div><p>Here’s what you’ll need to create this project:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Arduino and USB cable</p></li><li class="listitem"><p>Various connecting wires</p></li><li class="listitem"><p>Real-time clock module (shown earlier in the chapter)</p></li><li class="listitem"><p>LCD module or Freetronics LCD shield</p></li><li class="listitem"><p>MicroSD card shield and card (from <a class="xref" href="ch13.html" title="Chapter 13. Using GPS with Your Arduino">Chapter 13</a>)</p></li><li class="listitem"><p>ProtoScrewShield or similar product</p></li><li class="listitem"><p>RFID reader module and two tags (from <a class="xref" href="ch16.html" title="Chapter 16. Reading RFID Tags">Chapter 16</a>)</p></li></ul></div><p>To assemble the system, start with the Arduino Uno at the bottom, and then add your ProtoScrewShield, the microSD card shield, and the LCD shield on the top. Connect the RFID reader as you did in <a class="xref" href="ch16.html" title="Chapter 16. Reading RFID Tags">Chapter 16</a>, and connect the RTC module as described earlier in this chapter. The assembly should look similar to that shown in <a class="xref" href="ch18.html#time-clock_assembly" title="Figure 18-5. The time-clock assembly">Figure 18-5</a>.</p><div class="figure"><a id="time-clock_assembly"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00288"/><img src="httpatomoreillycomsourcenostarchimages1630346.png.jpg" alt="The time-clock assembly"/></div></div><div class="figure-title">Figure 18-5. The time-clock assembly</div></div></div><div class="sect2" title="The Sketch"><div class="titlepage"><div><div><h3 class="title" id="sketch-id00153">The Sketch</h3></div></div></div><p>Now enter and upload the following sketch. Remember that when you’re uploading sketches to an RFID-connected Arduino, you need to ensure that you remove the wire between the RFID reader RX and Arduino pin D0, and then reconnect it once the sketch has been uploaded successfully.</p><a id="pro_id00169"/><pre class="programlisting">  // Project 59 - Creating an RFID Time-Clock System

<span class="gray-background">1</span> #include "Wire.h" // for RTC
  #define DS3232_I2C_ADDRESS 0x68 
<span class="gray-background">2</span> #include "SD.h"  // for SD card

  #include &lt;LiquidCrystal.h&gt;
  LiquidCrystal lcd( 8, 9, 4, 5, 6, 7 );
  int data1 = 0;

<span class="gray-background">3</span> // Use Listing 16-1 to find your tag numbers
  int Mary[14] = {
    2, 52, 48, 48, 48, 56, 54, 67, 54, 54, 66, 54, 66, 3};
  int John[14] = {
    2, 52, 48, 48, 48, 56, 54, 66, 49, 52, 70, 51, 56, 3};
  int newtag[14] = {
    0,0,0,0,0,0,0,0,0,0,0,0,0,0}; // used for read comparisons

  // Convert normal decimal numbers to binary coded decimal
  byte decToBcd(byte val)
  {
    return( (val/10*16) + (val%10) );
  }

  // Convert binary coded decimal to normal decimal numbers
  byte bcdToDec(byte val)
  {
    return( (val/16*10) + (val%16) );
  }

  void setDS3232time(byte second, byte minute, byte hour, byte dayOfWeek, byte dayOfMonth, byte month, byte year)
  {
    // Sets time and date data to DS3232
    Wire.beginTransmission(DS3232_I2C_ADDRESS);
    Wire.write(0);  // set next input to start at the seconds register
    Wire.write(decToBcd(second));     // set seconds
    Wire.write(decToBcd(minute));     // set minutes
    Wire.write(decToBcd(hour));       // set hours
    Wire.write(decToBcd(dayOfWeek));  // set day of week (1=Sunday, 7=Saturday)
    Wire.write(decToBcd(dayOfMonth)); // set date (1 to 31)
    Wire.write(decToBcd(month));      // set month
    Wire.write(decToBcd(year));       // set year (0 to 99)
    Wire.endTransmission();
  }

  void readDS3232time(byte *second,
  byte *minute,
  byte *hour,
  byte *dayOfWeek,
  byte *dayOfMonth,
  byte *month,
  byte *year)
  {
    Wire.beginTransmission(DS3232_I2C_ADDRESS);
    Wire.write(0); // set DS3232 register pointer to 00h
    Wire.endTransmission();
    Wire.requestFrom(DS3232_I2C_ADDRESS, 7);

    // Request seven bytes of data from DS3232 starting from register 00h
    *second     = bcdToDec(Wire.read() &amp; 0x7f);
    *minute     = bcdToDec(Wire.read());
    *hour       = bcdToDec(Wire.read() &amp; 0x3f);
    *dayOfWeek  = bcdToDec(Wire.read());
    *dayOfMonth = bcdToDec(Wire.read());
    *month      = bcdToDec(Wire.read());
    *year       = bcdToDec(Wire.read());
  }

  void setup()
  {
    Serial.flush(); // need to flush serial buffer
    Serial.begin(9600);
    Wire.begin();
    lcd.begin(16, 2);
    // set the initial time here:
    // DS3232 seconds, minutes, hours, day, date, month, year
    //setDS3232time(0, 27, 0, 5, 15, 11, 12);

    // Check that the microSD card exists and can be used
<span class="gray-background">4</span>   if (!SD.begin(8))
    {
      lcd.print("uSD card failure");
      // stop the sketch
      return;
    }
    lcd.print("uSD card OK");
    delay(1000);
    lcd.clear();
  }

  // Compares two arrays and returns true if identical.
  // This is good for comparing tags.
  boolean comparetag(int aa[14], int bb[14])
  {
    boolean ff=false;
    int fg=0;
    for (int cc=0; cc&lt;14; cc++)
    {
      if (aa[cc]==bb[cc])
      {
        fg++;
      }
    }
    if (fg==14)
    {
      ff=true;      // all 14 elements in the array match each other
    }
    return ff;
  }

  void wipeNewTag()
  {
    for (int i=0; i&lt;=14; i++)
    {
      newtag[i]=0;
    }
  }

  void loop()
  {
    byte second, minute, hour, dayOfWeek, dayOfMonth, month, year;

    if (Serial.available() &gt; 0) // if a read has been attempted
    {
      // Read the incoming number on serial RX
      delay(100);  // Allow time for the data to come in from the serial buffer
      for (int z=0; z&lt;14; z++) // read the rest of the tag
      {
        data1=Serial.read();
        newtag[z]=data1;
      }
      Serial.flush(); // stops multiple reads
      // retrieve data from DS3232
      readDS3232time(&amp;second, &amp;minute, &amp;hour, &amp;dayOfWeek, &amp;dayOfMonth, &amp;month,
      &amp;year);
    }

    //now do something based on the tag type
<span class="gray-background">5</span>   if (comparetag(newtag, Mary) == true)
    {
      lcd.print("Hello Mary ");
      File dataFile = SD.open("DATA.TXT", FILE_WRITE);
      if (dataFile)
      {
        dataFile.print("Mary ");
        dataFile.print(hour);
        dataFile.print(":");
        if (minute&lt;10) { dataFile.print("0"); }
        dataFile.print(minute);
        dataFile.print(":");
        if (second&lt;10) { dataFile.print("0"); }
        dataFile.print(second);
        dataFile.print(" ");
        dataFile.print(dayOfMonth);
        dataFile.print("/");
        dataFile.print(month);
        dataFile.print("/");
        dataFile.print(year);
        dataFile.println();
        dataFile.close();
      }
      delay(1000);
      lcd.clear();
      wipeNewTag();
    }

    if (comparetag(newtag, John)==true)
    {
      lcd.print("Hello John ");
      File dataFile = SD.open("DATA.TXT", FILE_WRITE);
      if (dataFile)
      {
        dataFile.print("John ");
        dataFile.print(hour);
        dataFile.print(":");
        if (minute&lt;10) { dataFile.print("0"); }
        dataFile.print(minute);
        dataFile.print(":");
        if (second&lt;10) { dataFile.print("0"); }
        dataFile.print(second);
        dataFile.print(" ");
        dataFile.print(dayOfMonth);
        dataFile.print("/");
        dataFile.print(month);
        dataFile.print("/");
        dataFile.print(year);
        dataFile.println();
        dataFile.close();
      }
      delay(1000);
      lcd.clear();
      wipeNewTag();
    }
  }</pre></div><div class="sect2" title="How It Works"><div class="titlepage"><div><div><h3 class="title" id="how_it_works-id00154">How It Works</h3></div></div></div><p>In this sketch, the system first waits for an RFID card to be presented to the reader. If the RFID card is recognized, then the card owner’s name, the time, and the date are appended to a text file stored on the microSD card.</p><p>At <span class="gray-background">1</span> are the functions required for the I<sup>2</sup>C bus and the real-time clock, and at <span class="gray-background">2</span> is the line required to set up the microSD card shield. At <span class="gray-background">4</span>, we check and report on the status of the microSD card. At <span class="gray-background">5</span>, the card just read is compared against the stored card number for one of two people—in this case, John and Mary. If there is a match, the data is written to the microSD card. With some modification, you could add more cards to the system simply by adding the card serial numbers below the existing numbers at <span class="gray-background">3</span> and then adding other comparison functions like those at <span class="gray-background">5</span>.</p><p>When the time comes to review the logged data, simply copy the file <span class="emphasis"><em>data.txt</em></span> from the microSD card and view the data with a text editor; or import it into a spreadsheet for further analysis. The data is laid out so that it’s easy to read, as shown in <a class="xref" href="ch18.html#example_data_generated_by_project_59" title="Figure 18-6. Example data generated by Project 59">Figure 18-6</a>.</p><div class="figure"><a id="example_data_generated_by_project_59"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00289"/><img src="httpatomoreillycomsourcenostarchimages1630348.png.jpg" alt="Example data generated by Project 59"/></div></div><div class="figure-title">Figure 18-6. Example data generated by Project 59</div></div></div></div><div class="sect1" title="Looking Ahead"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="looking_ahead-id00155">Looking Ahead</h2></div></div></div><p>In this chapter you learned how to work with time and date data via the RTC IC. The RFID system described in Project 59 gives you the framework you need to create your own access systems or even track when your children arrive home. In the final two chapters, we’ll create projects that will use the Arduino to communicate over the Internet and a cellular phone network.</p></div></section></body></html>
